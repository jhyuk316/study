# 병렬성과 비동기성

> 컴퓨터는 어떻게 한 번에 많은 일을 하는가

- [1. 경합 조건이란 무엇인가](#1-경합-조건이란-무엇인가)
- [2. 공유 자원](#2-공유-자원)
- [3. 프로세스와 스레드](#3-프로세스와-스레드)
- [4. 락](#4-락)
  - [Test and Set](#test-and-set)
  - [4.1. 트랜잭션과 작업 크기](#41-트랜잭션과-작업-크기)
  - [Atomic 오퍼레이션](#atomic-오퍼레이션)
  - [CAS](#cas)
    - [ABA 문제](#aba-문제)
  - [비관적 락 vs 낙관적 락](#비관적-락-vs-낙관적-락)
  - [4.2. 락 대기](#42-락-대기)
  - [4.3. 교착 상태](#43-교착-상태)
  - [4.4. 단기 락 구현](#44-단기-락-구현)
  - [4.5. 장기 락 구현](#45-장기-락-구현)
- [5. 브라우저 자바스크립트](#5-브라우저-자바스크립트)
- [6. 비동기 함수와 프로미스](#6-비동기-함수와-프로미스)
- [A. JAVA의 ConcurrentHashMap](#a-java의-concurrenthashmap)
- [베리어](#베리어)
  - [사이클베리어(java)](#사이클베리어java)
  - [메모리 베리어](#메모리-베리어)
- [스핀락](#스핀락)
- [프로미스, 퓨처](#프로미스-퓨처)
- [7. 정리](#7-정리)
- [참고자료](#참고자료)

## 1. 경합 조건이란 무엇인가

- 경합
  - 2개 이상의 프로세스에서 같은 자원에 동시에 접근하고, 자원 사용 순서에 따라 결과가 달라지는 경우
  - 공유 자원을 동시에 접근 할 때 발생

## 2. 공유 자원

- 대부분의 자원은 공유될 수 있음.
- 메모리가 관련된 경우가 많음.
-

## 3. 프로세스와 스레드

## 4. 락

- Advisory Lock

### Test and Set

- CPU 아토믹 인스트럭션
- 락의 기본 인스트럭션
- 0 인지 검사 후 1로 셋

### 4.1. 트랜잭션과 작업 크기

- 트랜잭션 안의 모든 연산은 모두 다 성공하거나 모두 다 실패 함.

### Atomic 오퍼레이션

- 아토믹 결과를 보장 하는 명령

### CAS

- 미리가져 온 캐쉬된 데이터와 메모리의 데이터를 비교(Compare)해서 변경 되지 않으면 수행
- 미리가져 온 시점과 수행 시점의 변경되지 않음을 보장.
- 낙관적 락과 비슷
- ABA문제가 있으면 두배의 메모리를 사용해서 변경 횟수를 저장 할 수 있음.

#### ABA 문제

- 미리 가저온 메모리의 값 A를 다른 프로세스에서 B로 변경 했다가 다시 A로 변경하면 기존 프로세스는 이를 감지 할 수 없음.
- 감지 할 수 없지만 A의 오퍼레이션 자체는 문제를 알 수 없고 정상수행됨.

### 비관적 락 vs 낙관적 락

- 비관적 락

  - 락을 먼저 잡고 다른 프로세스의 접근을 막아서 아토믹을 보장

- 낙관적 락

  - 버전(값)을 미리 가지고 버전이 변경 되지 않으면 실행, 버전이 변경되었으면 거부
  - 락을 걸지 않고 락과 같은 효과를 발생

### 4.2. 락 대기

### 4.3. 교착 상태

### 4.4. 단기 락 구현

### 4.5. 장기 락 구현

## 5. 브라우저 자바스크립트

## 6. 비동기 함수와 프로미스

## A. JAVA의 ConcurrentHashMap

- 효율적인 동시성 문제를 해결하기 위한 해쉬맵
- 버킷 - 해쉬값이 같은 오브젝트가 들어가는 장소, 해쉬 충돌
- 버킷 안에서 equals로 같은 키를 찾음.
- 버킷 단위로 락을 걸어서 동시성 해결. 해쉬맵 전체에 동시성 락을 거는 것이 아님.
- 동시성 문제를 방지하기 위한 아토믹한 연산을 제공
  - ConcurrentMap 인터페이스에서 정의됨.
  - 하지만 사용자가 아토믹한 연산을 사용하지 않으면 동시성 문제가 발생.

## 베리어

### 사이클베리어(java)

- 필요한 자원을 베리어에 멈추게 한 뒤 한번에 실행되게 함.
- `public CyclicBarrier(int parties)`

### 메모리 베리어

- 프로그램 실행 순서를 보장하기 위해서 메모리 사용을

## 스핀락

- 락을 확인하는데 잠겨있으면 다시 락은 확인해서 락을 획득.

## 프로미스, 퓨처

- 퓨처
  - 비동기 결과를 반환하는 추상화
  - 완료시 결과를 가져 올 수 있음.

## 7. 정리

## 참고자료

- https://en.wikipedia.org/wiki/Test-and-set
- 아토믹 - https://en.wikipedia.org/wiki/Linearizability
